<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Form</title>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    label, select, input { display: block; margin: 10px 0; width: 100%; padding: 8px; }
    button { margin-top: 20px; padding: 10px; width: 100%; font-size: 16px; }
    img { margin-top: 20px; width: 100%; max-width: 300px; display: block; margin-left: auto; margin-right: auto; }
    #linkOutput { word-break: break-word; margin-top: 20px; }
  </style>
</head>
<body>

  <label for="company">Training Company:</label>
  <select id="company"></select>

  <label for="trainer">Trainer:</label>
  <select id="trainer"></select>

  <label for="product">Product:</label>
  <select id="product"></select>

  <label for="courseLevel">Course Level:</label>
  <select id="courseLevel"></select>

  <label for="trainingDate">Date:</label>
  <input id="trainingDate" type="date" />

  <label for="classTime">AM / PM:</label>
  <select id="classTime">
    <option value="AM">AM</option>
    <option value="PM">PM</option>
  </select>

  <label for="locationCity">City:</label>
  <input id="locationCity" type="text" placeholder="Enter city" />

  <label for="locationState">State:</label>
  <select id="locationState"></select>

  <button onclick="generateLink()">Generate Link & QR Code</button>

  <div id="linkOutput"></div>
  <img id="qrCode" src="" alt="QR Code" style="display: none;"/>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQ5H1jO6XPDvIN5CoIvlFFta2lPGE4WIk",
      authDomain: "training-qr-code.firebaseapp.com",
      projectId: "training-qr-code",
      storageBucket: "training-qr-code.firebasestorage.app",
      messagingSenderId: "79832187763",
      appId: "1:79832187763:web:86050298cbd1262faf3b06"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const companySelect = document.getElementById('company');
    const trainerSelect = document.getElementById('trainer');
    const productSelect = document.getElementById('product');
    const courseLevelSelect = document.getElementById('courseLevel');
    const locationStateSelect = document.getElementById('locationState');

    const stateOptions = [
      "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut","Delaware","Florida","Georgia",
      "Hawaii","Idaho","Illinois","Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland",
      "Massachusetts","Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
      "New Hampshire","New Jersey","New Mexico","New York","North Carolina","North Dakota","Ohio","Oklahoma",
      "Oregon","Pennsylvania","Rhode Island","South Carolina","South Dakota","Tennessee","Texas","Utah",
      "Vermont","Virginia","Washington","West Virginia","Wisconsin","Wyoming"
    ];

    stateOptions.forEach(state => {
      const option = document.createElement('option');
      option.value = state;
      option.textContent = state;
      locationStateSelect.appendChild(option);
    });

    let trainersByCompany = {};

    db.collection('companies').get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = data.name;
        companySelect.appendChild(option);
      });
      loadTrainers();
    });

    function loadTrainers() {
      db.collection('trainers').get().then(snapshot => {
        trainersByCompany = {};
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!trainersByCompany[data.companyId]) {
            trainersByCompany[data.companyId] = [];
          }
          trainersByCompany[data.companyId].push({id: doc.id, name: data.name});
        });
        updateTrainers();
      });
    }

    companySelect.addEventListener('change', updateTrainers);

    function updateTrainers() {
      const selectedCompany = companySelect.value;
      const trainers = trainersByCompany[selectedCompany] || [];
      trainerSelect.innerHTML = '';
      trainers.forEach(trainer => {
        const option = document.createElement('option');
        option.value = trainer.id;
        option.textContent = trainer.name;
        trainerSelect.appendChild(option);
      });
    }

    db.collection('products').get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const option = document.createElement('option');
        option.value = data.name;
        option.textContent = data.name;
        productSelect.appendChild(option);
      });
    });

    db.collection('courseLevels').orderBy('name').get().then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const option = document.createElement('option');
        option.value = data.name;
        option.textContent = data.name;
        courseLevelSelect.appendChild(option);
      });
    });

    function generateLink() {
      const companyName = companySelect.options[companySelect.selectedIndex].text;
      const trainerName = trainerSelect.options[trainerSelect.selectedIndex].text;
      const product = productSelect.value;
      const courseLevel = courseLevelSelect.value;
      const date = document.getElementById('trainingDate').value;
      const classTime = document.getElementById('classTime').value;
      const city = document.getElementById('locationCity').value;
      const state = document.getElementById('locationState').value;

      const baseURL = "https://www.boschheatingcooling.com/trf/";
      const params = new URLSearchParams({
        provider: companyName,
        trainer: trainerName,
        trainingCity: city,
        trainingState: state,
        product: product,
        lvl: courseLevel,
        classTime: classTime
      });

      const finalURL = `${baseURL}?${params.toString().replace(/&/g, "%26")}`;

      document.getElementById('linkOutput').innerHTML = `<strong>Link:</strong><br><a href="${finalURL}" target="_blank">${finalURL}</a>`;
      document.getElementById('qrCode').src = `https://quickchart.io/qr?text=${encodeURIComponent(finalURL)}&size=300`;
      document.getElementById('qrCode').style.display = 'block';
    }
  </script>
</body>
</html>
